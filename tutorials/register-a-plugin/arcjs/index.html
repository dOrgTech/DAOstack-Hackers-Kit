<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Arc.js - DAOstack Developer Portal</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../../css/theme.css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Arc.js";
    var mkdocs_page_input_path = "tutorials/register-a-plugin/arcjs.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> DAOstack Developer Portal</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../../arc2-overview/">Arc 2.0</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Stack</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="#">Infra</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/infra/intro/">Intro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/infra/holographic-consensus/">Holographic Consensus</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../../stack/arc/">Arc</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Subgraph</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/subgraph/intro/">Intro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/subgraph/queries/">GraphQL queries</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/subgraph/entities/">Entities</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">Arc.js</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/arcjs/intro/">Intro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/arcjs/intro/">Getting Started</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/arcjs/intro/">How To Use</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/arcjs/intro/">Query, Observables & Subscriptions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../stack/arcjs/intro/">Quick Example</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../../stack/alchemy/">Alchemy</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Plugins</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../../plugins/nft-manager/">NFT Manager</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../../plugins/funding-request/">Funding Request</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../../plugins/token-trade/">Token Trade</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../../test-environment/">Test environment</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../create-a-dao/">Create your own DAO</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../arc-react/">Arc.react</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="#">Register a generic plugin</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../intro/">Intro</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../arc/">Arc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../migration/">Migration</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../test-environment/">Test environment</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Arc.js</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#creating-the-folder-structure">Creating the folder structure</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#creating-the-plugin-class">Creating the Plugin class</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#interfaces">Interfaces</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#class-definition">Class definition</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#item-map">Item Map</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#initialize-params-mapper">Initialize Params Mapper</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#fragment">Fragment</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#create-proposal">Create Proposal</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#registering-the-plugin-class">Registering the Plugin class</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#creating-the-proposal-class">Creating the Proposal class</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#registering-the-proposal-class">Registering the Proposal Class</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#exporting-plugin-and-proposal-classes">Exporting Plugin and Proposal classes</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../alchemy/">Alchemy</a>
                </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">DAOstack Developer Portal</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Register a generic plugin &raquo;</li>
        
      
        
          <li>Tutorials &raquo;</li>
        
      
    
    <li>Arc.js</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/dOrgTech/DAOstack-Hackers-Kit/edit/master/docs/tutorials/register-a-plugin/arcjs.md"> Edit on dOrgTech/DAOstack-Hackers-Kit</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="registering-a-plugin-in-arcjs">Registering a Plugin in Arc.js</h1>
<h2 id="creating-the-folder-structure">Creating the folder structure</h2>
<p>To register a new plugin, add a folder in the <code>src/plugins</code> folder, with the name of the plugin to register and create 3 files:</p>
<ul>
<li>
<p>proposal.ts</p>
</li>
<li>
<p>plugin.ts</p>
</li>
<li>
<p>index.ts</p>
</li>
</ul>
<p>The index file is always the same:</p>
<pre><code class="ts">export * from './plugin'
export * from './proposal'
</code></pre>

<p>The Plugin class definition will live in the <code>plugin.ts</code> file and the Proposal class definition will live in the <code>proposal.ts</code> file.</p>
<h2 id="creating-the-plugin-class">Creating the Plugin class</h2>
<h3 id="interfaces">Interfaces</h3>
<p>The first step is to create 3 necessary interfaces:</p>
<ul>
<li><strong>Plugin State</strong>: it describes the plugin state and must extend <code>IPluginState</code> interface. Typically it just adds the <code>pluginParams</code>field. Example with the <code>TokenTrade</code> plugin:</li>
</ul>
<pre><code class="ts">export interface ITokenTradeState extends IPluginState {
  pluginParams: {
    votingMachine: Address
    voteParams: IGenesisProtocolParams
  }
}
</code></pre>

<ul>
<li><strong>Proposal Creation Options</strong>: it describes the arguments to pass to the proposal creation method. Must extend the <code>IProposalBaseCreateOptions</code>. Base options like dao address are already declared in the <code>IProposalBaseCreateOptions</code> interface. Example with the <code>TokenTrade</code> plugin:</li>
</ul>
<pre><code class="ts">export interface IProposalCreateOptionsTokenTrade extends IProposalBaseCreateOptions {
  sendTokenAddress: Address,
  sendTokenAmount: number,
  receiveTokenAddress: Address,
  receiveTokenAmount: number,
  descriptionHash: string
}
</code></pre>

<ul>
<li><strong>Initialize Parameters</strong>: it describes the parameters to pass to the initialize contract method. Example with the <code>TokenTrade</code> plugin:</li>
</ul>
<pre><code class="ts">export interface IInitParamsTT {
  daoId: string
  votingMachine: string
  votingParams: number[]
  voteOnBehalf: string
  voteParamsHash: string
}
</code></pre>

<h3 id="class-definition">Class definition</h3>
<p>If the plugin can create proposals, it must extend the <code>ProposalPlugin</code> class, if it can't, then it must extend the <code>Plugin</code> class.</p>
<p>For this example, we will be using the <code>TokenTrade</code> plugin. </p>
<p>The next step is to declare the class and make it extend <code>ProposalPlugin</code>, passing the 3 interfaces created in the previous section as type parameters:</p>
<pre><code class="ts">export class TokenTrade extends ProposalPlugin&lt;
  ITokenTradeState,
  ITokenTradeProposalState,
  IProposalCreateOptionsTokenTrade&gt; {... }
</code></pre>

<h3 id="item-map">Item Map</h3>
<p>Implement the public static itemMap method. This method follows the following signature: </p>
<pre><code class="ts">public static itemMap(context: Arc, item: any, queriedId?: string): ITokenTradeState
</code></pre>

<p>The goal of this method is to map the item object received by a query to an object of its interface.</p>
<p><code>Proposal</code> and <code>Plugin</code> abstract classes both have an <code>itemMapToBaseState</code> method that eases <code>itemMap</code> implementation and reduces code boilerplate.</p>
<p>It takes an optional <code>queriedId</code> parameter. This is the ID passed to the <code>where</code> clause of the GraphQL query. It is passed to have a meaningful error message, in case the query fails or does not yield any results. Should return null if it did not return results:</p>
<pre><code class="ts">public static itemMap(context: Arc, item: any, queriedId?: string): ITokenTradeState | null {
    if (!item) {
      return null
    }

    if (!item.tokenTradeParams) {
      throw new Error(`Plugin ${queriedId ? `with id '${queriedId}'` : ''}wrongly instantiated as TokenTrade Plugin`)
    }

    const baseState = Plugin.itemMapToBaseState(context, item)

    const tokenTradeParams = {
      voteParams: mapGenesisProtocolParams(item.tokenTradeParams.voteParams),
      votingMachine: item.tokenTradeParams.votingMachine
    }

    return {
        ...baseState,
        pluginParams: tokenTradeParams
      }
  }
</code></pre>

<h3 id="initialize-params-mapper">Initialize Params Mapper</h3>
<p>Next, implement the <code>initializeParamsMap</code> method, which follows the signature:</p>
<pre><code class="ts">public static initializeParamsMap(initParams: IInitParamsTT)
</code></pre>

<p>It takes an object with the plugin's initialize parameters and returns an array with the parameters organized in the correct order to be passed to its contract, through the <code>PluginManager</code>:</p>
<pre><code class="ts">public static initializeParamsMap(initParams: IInitParamsTT) {

  Object.keys(initParams).forEach((key) =&gt; {
    if (initParams[key] === undefined) {
      throw new Error(`TokenTrade's initialize parameter '${key}' cannot be undefined`)
    }
  })

  return [
    initParams.daoId,
    initParams.votingMachine,
    initParams.votingParams,
    initParams.voteOnBehalf,
    initParams.voteParamsHash
  ]
}
</code></pre>

<h3 id="fragment">Fragment</h3>
<p>Declare the public static <code>fragment</code> getter method and <code>fragmentField</code> private static property:</p>
<pre><code class="ts">private static fragmentField: { name: string, fragment: DocumentNode } | undefined
</code></pre>

<pre><code class="ts">public static get fragment() {
    if (!this.fragmentField) {
      this.fragmentField = {
        name: 'TokenTradeParams',
        fragment: gql` fragment TokenTradeParams on ControllerScheme {
          tokenTradeParams {
            id
            votingMachine
            voteParams {
              id
              queuedVoteRequiredPercentage
              queuedVotePeriodLimit
              boostedVotePeriodLimit
              preBoostedVotePeriodLimit
              thresholdConst
              limitExponentValue
              quietEndingPeriod
              proposingRepReward
              votersReputationLossRatio
              minimumDaoBounty
              daoBountyConst
              activationTime
              voteOnBehalf
            }
          }
        }`
      }
    }

    return this.fragmentField
  }
</code></pre>

<p>Its objective is to include this plugin's specific fields in the general plugin search query. </p>
<p>The name used for the actual GraphQL fragment definition must match the name property of the <code>fragmentField</code> property, in this case they both are: 'TokenTradeParams'. Typically the fragment starts with the name of the plugin, camel-cased and followed by 'Params', in this case it is 'tokenTradeParams'</p>
<h3 id="create-proposal">Create Proposal</h3>
<p>Next, implement the <code>createProposalTransactionMap</code> and <code>createProposalErrorHandler</code>, that always follow the same pattern:</p>
<pre><code class="ts">  public createProposalTransactionMap(): transactionResultHandler&lt;any&gt; {
    return async (receipt: ITransactionReceipt) =&gt; {
      const args = getEventArgs(receipt, 'TokenTradeProposed', 'TokenTrade.createProposal')
      const proposalId = args[1]
      return new TokenTradeProposal(this.context, proposalId)
    }
  }

  public createProposalErrorHandler(options: IProposalCreateOptionsTokenTrade): transactionErrorHandler {
    return async (err) =&gt; {
      throw err
    }
  }

</code></pre>

<p>You would only need to change the name of the event emitted by the contract on proposal creation, and the create proposal method, as shown above.</p>
<p>Lastly, implement the <code>createProposalTransaction</code> method. This method has validation logic for each of the proposal creation options, saves the description hash to IPFS if there is none created beforehand and returns an object that contains the plugin's contract address, the name of the contract method to create a proposal and the arguments for it, organized in an array:</p>
<pre><code class="ts">public async createProposalTransaction(options: IProposalCreateOptionsTokenTrade): Promise&lt;ITransaction&gt; {

    if (options.plugin === undefined) {
      throw new Error(`Missing argument &quot;plugin&quot; for TokenTrade in Proposal.create()`)
    }
    if (!options.receiveTokenAddress) {
      throw new Error(`Missing argument &quot;receiveTokenAddress&quot; for TokenTrade in Proposal.create()`)
    }
    if (!options.sendTokenAddress) {
      throw new Error(`Missing argument &quot;sendTokenAddress&quot; for TokenTrade in Proposal.create()`)
    }
    if (options.receiveTokenAmount &lt;= 0) {
      throw new Error(`Argument &quot;receiveTokenAmount&quot; must be greater than 0 for TokenTrade in Proposal.create()`)
    }
    if (options.sendTokenAmount &lt;= 0) {
      throw new Error(`Argument &quot;sendTokenAmount&quot; must be greater than 0 for TokenTrade in Proposal.create()`)
    }

    if (!options.descriptionHash) {
      options.descriptionHash = await this.context.saveIPFSData(options)
    }

    const { address: pluginAddress } = await this.fetchState()

    await this.context.approveTokens(options.sendTokenAddress, pluginAddress, new BN(options.sendTokenAmount)).send()

    return {
      contract: this.context.getContract(pluginAddress),
      method: 'proposeTokenTrade',
      args: [
        options.sendTokenAddress,
        options.sendTokenAmount,
        options.receiveTokenAddress,
        options.receiveTokenAmount,
        options.descriptionHash
      ]
    }
  }
</code></pre>

<p><strong>IMPORTANT NOTE: all other Arc.js entities or classes. used in this class must be imported from the <code>src/index</code> file</strong>:</p>
<pre><code class="ts">import {
  Address,
  Arc,
  getEventArgs,
  IGenesisProtocolParams,
  IPluginState,
  IProposalBaseCreateOptions,
  ITransaction,
  ITransactionReceipt,
  mapGenesisProtocolParams,
  Plugin,
  ProposalPlugin,
  transactionErrorHandler,
  transactionResultHandler
} from '../../index'

</code></pre>

<h2 id="registering-the-plugin-class">Registering the Plugin class</h2>
<p>The plugin class must be exported in the <code>./src/plugins/utils.ts</code> file. Including it in the already exported <code>Plugins</code> or <code>ProposalPlugins</code> object, mapped to its subgraph name.</p>
<p>The <code>IProposalCreateOptions</code> interface must be included in the already exported <code>ProposalCreateOptions</code> type in the <code>./src/plugins/utils.ts</code> file.</p>
<p>The Init Params interface must also be imported an mapped into the <code>InitParams</code> object in this file.</p>
<pre><code class="ts">export const ProposalPlugins = {
  FundingRequest,
  Join,
  GenericScheme: GenericPlugin,
  SchemeRegistrar: PluginRegistrarPlugin,
  ContributionReward: ContributionRewardPlugin,
  TokenTrade,
  Unknown: UnknownPlugin
  ...
}

export const Plugins = {
  ...ProposalPlugins,
  ReputationFromToken: ReputationFromTokenPlugin,
  Unknown: UnknownPlugin
}

export interface IInitParams {
  GenericScheme: IInitParamsGS,
  ContributionReward: IInitParamsCR,
  Competition: IInitParamsCompetition,
  ...
}

export type ProposalCreateOptions =
  IProposalCreateOptionsCRExt |
  IProposalCreateOptionsGS |
  IProposalCreateOptionsSR |
  ...
</code></pre>

<h2 id="creating-the-proposal-class">Creating the Proposal class</h2>
<p>The Proposal class definition is, in essence, almost the same as the Plugin class definition, with some differences:</p>
<ul>
<li>The only interface that needs to be declared prior to the class creation is the Proposal State interface, which must always extend the <code>IProposalState</code> interface. An example would be:</li>
</ul>
<pre><code class="ts">export interface ITokenTradeProposalState extends IProposalState {
  dao: IEntityRef&lt;DAO&gt;
  beneficiary: Address
  sendTokenAddress: Address
  sendTokenAmount: number
  receiveTokenAddress: Address
  receiveTokenAmount: number
  executed: boolean
  redeemed: boolean
}
</code></pre>

<ul>
<li>The proposal class to be created needs to extend the abstract <code>Proposal</code> class, which takes the interface mentioned above as a type parameter:</li>
</ul>
<pre><code class="ts">export class TokenTradeProposal extends Proposal&lt;ITokenTradeProposalState&gt; { ... }
</code></pre>

<ul>
<li>The <code>state</code> method must be implemented. It always follows the same implementation. You only need to change the <code>Observable</code>'s type parameter with the proper Proposal State interface:</li>
</ul>
<pre><code class="ts">public state(apolloQueryOptions: IApolloQueryOptions): Observable&lt;ITokenTradeProposalState&gt; {
    const query = gql`query ProposalState
      {
        proposal(id: &quot;${this.id}&quot;) {
          ...ProposalFields
          votes {
            id
          }
          stakes {
            id
          }
        }
      }
      ${Proposal.baseFragment}
      ${Plugin.baseFragment}
    `

    const result = this.context.getObservableObject(
      this.context, query, TokenTradeProposal.itemMap, this.id, apolloQueryOptions
      ) as Observable&lt;ITokenTradeProposalState&gt;
    return result
  }
</code></pre>

<ul>
<li>The redeem method must be implemented</li>
</ul>
<h2 id="registering-the-proposal-class">Registering the Proposal Class</h2>
<p>The plugin class must be exported in the <code>./src/plugins/utils.ts</code> file. Including it in the already exported <code>Proposals</code> object, mapped to its subgraph name:</p>
<pre><code class="ts">export const Proposals = {
  GenericScheme: GenericPluginProposal,
  ContributionReward: ContributionRewardProposal,
  Competition: CompetitionProposal,
  ContributionRewardExt: ContributionRewardExtProposal,
  FundingRequest: FundingRequestProposal,
  TokenTrade: TokenTradeProposal,
  Join: JoinProposal,
  SchemeRegistrar: PluginRegistrarProposal,
  SchemeRegistrarAdd: PluginRegistrarProposal,
  SchemeRegistrarRemove: PluginRegistrarProposal,
  SchemeFactory: PluginManagerProposal,
  Unknown: UnknownProposal
}
</code></pre>

<h2 id="exporting-plugin-and-proposal-classes">Exporting Plugin and Proposal classes</h2>
<p>The folder containing the plugin and proposal classes that were just implemented must be exported in the <code>src/index</code> file:</p>
<pre><code class="ts">export * from './entity'
export * from './plugins/plugin'
export * from './plugins/proposal'
export * from './plugins/proposalPlugin'
export * from './plugins/contributionReward'
export * from './plugins/contributionRewardExt'
export * from './plugins/tokenTrade'
...
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../alchemy/" class="btn btn-neutral float-right" title="Alchemy">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../test-environment/" class="btn btn-neutral" title="Test environment"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../test-environment/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../alchemy/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
